
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Objective-C Runtime - Daniel Beard</title>
  <meta name="author" content="Daniel Beard">

  
  <meta name="description" content="It is pretty rare to actually have to dive into the objc-runtime for any day to day coding. Most developers wont have to touch the runtime, however &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://danielbeard.io/blog/2013/04/16/objective-c-runtime">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Daniel Beard" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=Open+Sans:400,700&subset=latin" rel="stylesheet" type="text/css" />
<link href='http://fonts.googleapis.com/css?family=Noto+Serif:400,700' rel='stylesheet' type='text/css'>



  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <nav id="main-nav" role="navigation">
<ul class="main-navigation">
  <li><a href="/" class="nav-link">Blog</a></li>
  <li><a href="/blog/archives" class="nav-link">Archives</a></li>
	<li><a href="https://github.com/daniel-beard">GitHub</a></li>
	<li><a href="/about">About</a></li>
</ul>

</nav>
  
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Objective-C Runtime</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-16T05:38:24-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>It is pretty rare to actually have to dive into the objc-runtime for any day to day coding. Most developers wont have to touch the runtime, however it is helpful to know what is possible and be able to use it if required. The objective-c runtime is written in C and is how the underlying parts of the objective-c language work including message sending, ivars and properties. This post shows an example of where I have used the Objective-C runtime in one of my projects.</p>

<p>One example of where I have used the runtime in my projects is the validation code in <code>DBValidator</code>. The validation code is implemented as a category on <code>NSObject</code> called <code>NSObject+DBValidator</code>. This is so we can add validation rules to <strong>any</strong> objective-c object. The only problem with this approach is that you <em>can&rsquo;t</em> add any properties or ivars to an object using a category.</p>

<p>We can work around this limitation by using the objective-c runtime directly.</p>

<p>Below is the implementation of the <code>NSObject+DBValidator</code> category:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>    <span class="cp">#import &quot;NSObject+DBValidator.h&quot;</span>
</span><span class='line'>    <span class="cp">#import &lt;objc/runtime.h&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#define VALIDATION_RULES_KEY @&quot;validationruleskey&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">@implementation</span> <span class="bp">NSObject</span> <span class="nl">(DBValidator)</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nl">setValidationRules</span><span class="p">:(</span><span class="bp">NSMutableArray</span> <span class="o">*</span><span class="p">)</span><span class="n">validationRules</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">objc_setAssociatedObject</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">VALIDATION_RULES_KEY</span><span class="p">,</span> <span class="n">validationRules</span><span class="p">,</span> <span class="n">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">-</span><span class="p">(</span><span class="bp">NSMutableArray</span><span class="o">*</span><span class="p">)</span> <span class="n">validationRules</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">validationRules</span> <span class="o">=</span> <span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">VALIDATION_RULES_KEY</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">validationRules</span><span class="p">)</span>
</span><span class='line'>            <span class="n">validationRules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">validationRules</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nl">addValidationRule</span><span class="p">:</span> <span class="p">(</span><span class="n">DBValidationRule</span><span class="o">*</span><span class="p">)</span> <span class="n">validationRule</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">validationRules</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">validationRules</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">validationRule</span><span class="p">)</span>
</span><span class='line'>            <span class="p">[</span><span class="n">validationRules</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">validationRule</span><span class="p">];</span>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">validationRules</span> <span class="o">=</span> <span class="n">validationRules</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">removeAllValidationRules</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">validationRules</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">validationRules</span><span class="p">;</span>
</span><span class='line'>        <span class="p">[</span><span class="n">validationRules</span> <span class="n">removeAllObjects</span><span class="p">];</span>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">validationRules</span> <span class="o">=</span> <span class="n">validationRules</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">-</span><span class="p">(</span><span class="bp">NSMutableArray</span><span class="o">*</span><span class="p">)</span> <span class="n">validate</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">failureMessages</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">DBValidationRule</span> <span class="o">*</span><span class="n">rule</span> <span class="k">in</span> <span class="nb">self</span><span class="p">.</span><span class="n">validationRules</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kt">BOOL</span> <span class="n">isValid</span> <span class="o">=</span> <span class="p">[</span><span class="n">rule</span> <span class="n">passesValidation</span><span class="p">];</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isValid</span><span class="p">)</span>
</span><span class='line'>                 <span class="p">[</span><span class="n">failureMessages</span> <span class="nl">addObject</span><span class="p">:</span> <span class="n">rule</span><span class="p">.</span><span class="n">failureMessage</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">failureMessages</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have a <code>@property</code> defined in the header called <code>validationRules</code> and we override both the setter and getter in the implementation. In the <code>setValidationRules:</code> method we use a C function from the objective-c runtime called <a href="https://developer.apple.com/library/mac/#documentation/Cocoa/Reference/ObjCRuntimeRef/Reference/reference.html"><code>objc_setAssociatedObject</code></a>. This function allows us to set a reference on the <code>self</code> object. We give it a key, the object (in this case the <code>validationRules</code> passed to the method) and the association policy.</p>

<p>The valid options for the association policy are:</p>

<pre><code>enum {
   OBJC_ASSOCIATION_ASSIGN = 0,
   OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1,
   OBJC_ASSOCIATION_COPY_NONATOMIC = 3,
   OBJC_ASSOCIATION_RETAIN = 01401,
   OBJC_ASSOCIATION_COPY = 01403
};
</code></pre>

<p>Notice how these options map directly to <code>@property</code> storage options! We are using <code>OBJC_ASSOCIATION_RETAIN_NONATOMIC</code> because we want our <code>NSObject</code> to retain the validation rules that are set on it.</p>

<p>In our <code>validationRules</code> method, we use a similar call from the objective-c runtime called <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/ObjCRuntimeRef/Reference/reference.html#//apple_ref/doc/uid/TP40001418-CH1g-SW68"><code>objc_getAssociatedObject</code></a>. This allows us to retrieve the object we set a reference to in the preious method. We have to pass the parent object and the key for the associated object we want. We return an empty array if validation rules are not yet set for this object.</p>

<p>Check out the full source code in the <a href="https://github.com/daniel-beard/DBValidator">DBValidator GitHub Project</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">danielbeard</span></span>

      








  


<time datetime="2013-04-16T05:38:24-07:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/general-dev/'>general dev</a>, <a class='category' href='/blog/categories/ios/'>ios</a>, <a class='category' href='/blog/categories/objective-c/'>objective-c</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://danielbeard.io/blog/2013/04/16/objective-c-runtime/" data-via="_danielbeard" data-counturl="http://danielbeard.io/blog/2013/04/16/objective-c-runtime/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/04/15/git-notes/" title="Previous Post: Git notes">&laquo; Git notes</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/04/17/objective-c-style-guide/" title="Next Post: Objective-C Style Guide">Objective-C Style Guide &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Daniel Beard -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
